EasyDiscuss.require(["jquery.suggest","@easydiscuss.controllers.tagform.tagitem"],function(a){EasyDiscuss.Controllers("TagForm",{defaults:{mode:"entry",tags:[],dataset:[],"{textField}":".tagform-textfield","{pickerField}":".tagform-pickerfield","{tagList}":".tagform-taglist","{tagListMessage}":".tagform-taglist-message","{tagItemGroup}":".tagform-tagitemgroup","{tagItem}":".tagform-tagitem","{removeTagButton}":".tagform-tagitem-remove","@tagItem":"easydiscuss.controllers.tagform.tagitem"}},function(b){return{init:function(){b.options.mode!="picker"&&b.textField().show(),b.textField().implement("Foundry.Suggest",{lookup:{inside:b.options.dataset,within:["title"]},keyword:{separator:",",includeAsSuggestion:!0},contextMenu:{display:{position:{my:"left bottom",at:"left top"}},onSelectItem:b.addTag}},function(){b.suggest=this,b.datamap={},a.each(b.suggest.dataset(),function(a,c){b.datamap[c.id]=c}),b.tags={},a.map(b.options.tags,function(a){b.addTag(b.datamap[a.id])}),b.suggest.contextMenu.element.addClass("tagform-contextmenu"),b.refreshTagList();if(b.options.mode=="picker"){var c=b.suggest.search();b.renderTag(c)}})},getTag:function(c){return a(b.tagItem("."+c[".suggestId"])[0]||b.tagItem(function(){return a(this).find('input[name="tags[]"]').val()==c.title})[0])},addTag:function(c){var d=c[".suggestId"],e=b.getTag(c)[0],f=a(e||a.View(b.template("tagItem"),c));f.prependTo(b.tagItemGroup()).hide().fadeIn(),e||(f.data("suggestId",d),b.tags[d]={data:c,item:f},b.suggest.exclude(d)),b.refreshTagList()},removeTag:function(a){var c=b.tags[a];b.options.mode=="picker"&&b.pickerField().find(".pickId-"+c.data.id).show(),c.item.remove(),b.suggest.include(a),delete b.tags[a],b.refreshTagList()},removeAllTags:function(){b.tagItemGroup().empty(),b.suggest.options.lookup.exclude=[],b.tags={},b.refreshTagList()},renderTag:function(c){a.each(c,function(c,d){var e=a("<li>").html(d.title).addClass("pickId-"+d.id).data("tag",d).click(b.pickTag).appendTo(b.pickerField())}),b.refreshTagList()},pickTag:function(){var c=a(this);c.hide(),b.addTag(c.data("tag"))},refreshTagList:function(){if(b.options.mode=="picker"){var a=b.pickerField().find("li:visible").length>0;b.element.find(".select-tag").toggle(a)}b.tagListMessage().html(b.tagItem().length<1?b.options.lang.COM_EASYDISCUSS_POST_NO_TAGS_ASSIGNED_YET:"")},"{removeTagButton} click":function(a,c){var d=a.parents(b.options["{tagItem}"]),e=d.data("suggestId");b.removeTag(e)}}})});