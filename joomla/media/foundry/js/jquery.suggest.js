Foundry.require(["jquery.lookup","jquery.ui.core","jquery.ui.position","@jquery.suggest.contextmenu","@jquery.suggest.contextmenu.item"],function(a){a.Controller("Foundry.Suggest",{defaults:{lookup:{inside:[],within:[],exclude:[]},keyword:{separator:" ",includeAsSuggestion:!1,clearAfterSelection:!0},contextMenu:{display:{format:"<@= title @>",after:500,whenFocused:!0,withoutKeyword:!0,persist:!1,hideAfterSelection:!0,position:{my:"left top",at:"left bottom",collision:"none"},css:{}},onRenderItem:function(a,b){return undefined},onSelectItem:function(a,b){},"@menu":"jquery.suggest.contextmenu","@menuItem":"jquery.suggest.contextmenu.item","{menu}":".suggest-contextmenu","{menuItemGroup}":".suggest-contextmenu-itemgroup","{menuItem}":".suggest-contextmenu-item"}}},function(b){return{init:function(){b.textField=b.element,b.dataset(b.options.lookup.inside);var c=a(a.View(b.options.contextMenu["@menu"],{}));c.appendTo("body").implement("Foundry.Suggest.ContextMenu",a.extend(b.options.contextMenu,{parent:b}),function(){b.contextMenu=this})},dataset:function(c){if(c==undefined)return b.options.lookup.inside;if(!a.isArray(c))return;b.datamap={},a.map(c,function(a){b.attachMeta(a)}),b.options.lookup.inside=c},attachMeta:function(c,d){var e=a.uid("suggestId_");return b.datamap[e]=a.extend(!0,c,{".suggestId":e,".suggestType":"data",".suggestBuffer":b.buffer(c)},d)},buffer:function(c){var d="",e=function(b){if(typeof b=="string"||a.isNumeric(b))d+=b+" "},f=b.options.lookup.within;return f.length>0?a.each(f,function(a,b){e(c[b])}):a.each(c,function(a,b){a.match(".suggest")||e(b)}),a.trim(d)},search:function(c){return c==undefined&&(c=""),a.lookup(a.extend({},b.options.lookup,{using:c,within:[".suggestBuffer"]}))},populate:function(c){c=a.cleanDelimiter(c||b.textField.val(),b.options.keyword.separator);if(c==""&&(!b.contextMenu.options.display.withoutKeyword||b.dataset().length<1)){b.contextMenu.hide();return}var d=b.search(c);if(c!=""&&b.options.keyword.includeAsSuggestion){var e=b.attachMeta({title:c},{".suggestType":"user"});d.push(e)}if(d.length<1){b.contextMenu.hide(!0);return}b.contextMenu.show(d)},exclude:function(a){b.options.lookup.exclude.push({".suggestId":a})},include:function(c){b.options.lookup.exclude=a.grep(b.options.lookup.exclude,function(a){return a[".suggestId"]==c},!0)},focusin:function(a,c){b.contextMenu.options.display.whenFocused&&b.populate()},focusout:function(a,b){},keydown:function(c,d){b.realEnterKey=d.keyCode==a.ui.keyCode.ENTER,b.contextMenu.keyboardLock=!0;switch(d.keyCode){case a.ui.keyCode.UP:b.contextMenu.activate("previousItem");break;case a.ui.keyCode.DOWN:b.contextMenu.activate("nextItem")}},keypress:function(c,d){b.realEnterKey=b.realEnterKey&&d.keyCode==a.ui.keyCode.ENTER},keyup:function(c,d){switch(d.keyCode){case a.ui.keyCode.ESCAPE:b.contextMenu.hide();break;case a.ui.keyCode.ENTER:b.realEnterKey?b.contextMenu.select():b.populate();break;default:b.populate()}}}}),a.Controller("Foundry.Suggest.ContextMenu",{defaults:{}},function(b){return{init:function(){b.parent=b.options.parent,b.contextMenu=b.element,b.options.display.position.of==undefined&&(b.options.display.position.of=b.parent.textField),b.options.display.css.width==undefined&&(b.options.display.css.width=a(b.options.display.position.of).outerWidth())},show:function(a){b.render(a),b.contextMenu.show(0,function(){b.contextMenu.css(b.options.display.css).position(b.options.display.position)})},hide:function(a){b.menuItem().removeClass("active"),b.parent.restoreTextFieldFocus&&b.parent.textField.focus(),(!b.options.persist||a)&&b.element.hide()},render:function(c){var d=b.menuItemGroup();d.empty(),a.each(c,function(c,e){var f=e[".suggestId"],g=e[".suggestType"],h=a(b.options.onRenderItem(e,g)||a.View(b.template("menuItem"),{data:e,title:e.title}));h.addClass(f).addClass("suggestType_"+g).data("suggestId",f).appendTo(d)});var e=a(b.menuItem("."+b.lastActivatedItem)[0]||b.menuItem(".suggestType_user")[0]||b.menuItem(":first"));e.addClass("active"),b.lastActivatedItem=e.data("suggestId")},lastActivatedItem:"null",activate:function(c){var d,e=b.menuItem(),f=e.filter(".active"),g=e.index(f);switch(c){case"nextItem":d=e.eq(a.Number.rotate(g,0,e.length-1,1));break;case"previousItem":d=e.eq(a.Number.rotate(g,0,e.length-1,-1));break;default:d=b.menuItem("."+c)}if(d.length<1)return;e.removeClass("active"),d.addClass("active"),b.lastActivatedItem=d.data("suggestId");if(b.keyboardLock){var h=b.contextMenu.scrollTop(),i=b.contextMenu.height()+h,j=d.position().top+h,k=j+d.outerHeight(!0);(j<=h||k>=i)&&d[0].scrollIntoView()}},select:function(){var a=b.menuItem(".active");if(a.length<1)return;var c=b.parent.datamap[a.data("suggestId")];b.options.onSelectItem(c,c[".suggestType"]),b.parent.options.keyword.clearAfterSelection&&b.parent.textField.val(""),b.parent.restoreTextFieldFocus=!0,b.options.display.hideAfterSelection&&b.hide(!0)},mouseover:function(){b.options.persist=!0},mouseout:function(){b.options.persist=!1},mousemove:function(){b.keyboardLock=!1},"{menuItem} mouseover":function(a){b.keyboardLock==0&&b.activate(a.data("suggestId"))},"{menuItem} click":function(a,c){b.menuItem().removeClass("active"),a.addClass("active"),b.select()}}})});